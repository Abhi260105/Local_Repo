<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Daily Task Tracker ‚Äî Enhanced</title>
<style>
  :root{
    --bg:#0a0a0a; --card:#141416; --muted:#9aa3a3; --accent:#64ffda; --accent-2:#1de9b6;
    --danger:#f44336; --success:#4caf50; --radius:12px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    background:var(--bg); color:#fff; font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto; -webkit-font-smoothing:antialiased;
  }
  .container{max-width:820px;margin:18px auto;padding:14px 16px 120px}

  .header{background:linear-gradient(135deg,#12121b,#18202e);border-radius:var(--radius);padding:14px;border:1px solid rgba(255,255,255,0.04);text-align:center;margin-bottom:14px}
  .header h1{color:var(--accent);font-size:1.25rem;margin-bottom:6px}
  .current-date{color:var(--accent);font-weight:700;margin-bottom:6px;font-size:0.95rem}
  .header p{color:var(--muted);font-size:0.86rem}

  .add-task {display:flex;gap:10px;margin-bottom:12px}
  .task-input{flex:1;padding:12px 14px;border-radius:999px;background:transparent;border:2px solid rgba(255,255,255,0.04);color:#fff;font-size:0.98rem;outline:none}
  .task-input:focus{border-color:var(--accent);box-shadow:0 0 16px rgba(100,255,218,0.06)}
  .add-btn{border-radius:999px;padding:10px 16px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#000;font-weight:700;cursor:pointer;transition:transform .2s}
  .add-btn:hover{transform:scale(1.05)}

  .card{background:linear-gradient(180deg,#101014,#121218);border-radius:var(--radius);padding:12px;border:1px solid rgba(255,255,255,0.04);margin-bottom:14px}
  .table-header{display:grid;grid-template-columns:1fr 120px;gap:10px;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.03)}
  .table-header .left{color:var(--accent);font-weight:800;text-align:left;padding-left:6px}
  .table-header .right{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#000;border-radius:10px;font-weight:800;display:flex;align-items:center;justify-content:center}

  .tasks-list{display:flex;flex-direction:column;gap:10px}
  .task-row{position:relative;overflow:visible;display:flex;gap:10px;align-items:center;min-height:56px}
  .task-content{background:var(--card);flex:1;padding:12px;border-radius:10px;display:flex;align-items:center;gap:12px;border:1px solid rgba(255,255,255,0.03);transform:translateX(0);transition:transform .22s ease;touch-action:pan-y;cursor:pointer}
  .task-content:hover{border-color:rgba(100,255,218,0.1);background:linear-gradient(180deg,#141418,#16161c)}
  .task-title{flex:1;font-weight:600;color:#fff;word-break:break-word}
  .task-meta{display:flex;gap:10px;align-items:center}
  .filter-btn{
    padding:8px 14px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,0.04);
    background:transparent;
    color:var(--muted);
    cursor:pointer;
    transition:all .2s;
    font-weight:600;
    font-size:0.88rem;
  }
  .filter-btn:hover{
  border-color:rgba(100,255,218,0.2);
  color:var(--accent);
  }
  .filter-btn.active{
  background:linear-gradient(90deg,var(--accent),var(--accent-2));
  color:#000;
  border-color:transparent;
  }
  .icon-bell{cursor:pointer;font-size:1.05rem;user-select:none;transition:transform .2s}
  .icon-bell:hover{transform:scale(1.2)}
  .badge{width:8px;height:8px;border-radius:50%;background:var(--danger);display:inline-block;margin-left:-6px;margin-top:-6px}

  .swipe-delete{position:absolute;right:6px;top:6px;bottom:6px;width:84px;border-radius:10px;background:linear-gradient(90deg,transparent,var(--danger));display:flex;align-items:center;justify-content:center;color:#fff;pointer-events:none;opacity:0;transition:opacity .18s;cursor:pointer}
  .task-row.show-delete .swipe-delete{opacity:1;pointer-events:auto}

  .status-actions{display:flex;gap:8px}
  .btn-status{border-radius:8px;padding:6px 8px;border:1px solid rgba(255,255,255,0.04);cursor:pointer;background:transparent;color:var(--muted);font-weight:700;font-size:0.88rem;transition:all .2s}
  .btn-yes{background:linear-gradient(90deg,rgba(100,255,218,0.12),transparent);border-color:rgba(100,255,218,0.12);color:var(--accent);box-shadow:0 4px 14px rgba(100,255,218,0.04)}
  .btn-yes:hover{transform:scale(1.1);box-shadow:0 6px 18px rgba(100,255,218,0.1)}
  .btn-no{background:linear-gradient(90deg,rgba(244,67,54,0.06),transparent);border-color:rgba(244,67,54,0.06);color:var(--danger)}
  .btn-no:hover{transform:scale(1.1)}

  .status-badge{font-size:1.1rem;padding:6px;border-radius:8px}
  .done{color:var(--success)}
  .failed{color:var(--danger)}

  .history-section{display:none}
  .history-section.active{display:block}
  
  .stat-box{background:rgba(255,255,255,0.02);border-radius:8px;padding:12px;text-align:center;border:1px solid rgba(255,255,255,0.03)}
  .stat-value{font-size:1.8rem;font-weight:800;color:var(--accent);margin-bottom:4px}
  .stat-label{font-size:0.8rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}

  .history-item-row{position:relative;overflow:visible;display:flex;gap:10px;align-items:center;min-height:80px;margin-bottom:10px}
  .task-history-item{background:rgba(255,255,255,0.02);border-radius:10px;padding:12px;border:1px solid rgba(255,255,255,0.03);cursor:pointer;transition:all .2s;flex:1;transform:translateX(0);touch-action:pan-y}
  .task-history-item:hover{background:rgba(100,255,218,0.05);border-color:rgba(100,255,218,0.1);transform:translateY(-2px)}
  .history-delete{position:absolute;left:6px;top:6px;bottom:6px;width:84px;border-radius:10px;background:linear-gradient(90deg,var(--danger),transparent);display:flex;align-items:center;justify-content:center;color:#fff;pointer-events:none;opacity:0;transition:opacity .18s;cursor:pointer}
  .history-item-row.show-delete .history-delete{opacity:1;pointer-events:auto}
  .task-history-title{font-weight:700;color:#fff;margin-bottom:8px;font-size:1rem}
  .task-history-stats{display:flex;gap:16px;font-size:0.88rem;color:var(--muted);flex-wrap:wrap}
  .task-history-stat{display:flex;align-items:center;gap:6px}

  .history-calendar{margin-top:12px}
  .history-calendar .weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:6px}
  .history-calendar .weekday{font-size:0.7rem;color:var(--muted);text-align:center;font-weight:600}
  .history-calendar .days-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
  .history-calendar .day-cell{min-height:40px;border-radius:6px;background:rgba(255,255,255,0.02);padding:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:0.75rem;border:1px solid rgba(255,255,255,0.02)}
  .history-calendar .day-cell .day-num{font-weight:600;margin-bottom:2px}
  .history-calendar .day-cell .day-status{font-size:1rem}
  .history-calendar .day-cell.completed{background:rgba(76,175,80,0.15);border-color:rgba(76,175,80,0.3);color:var(--success)}
  .history-calendar .day-cell.failed{background:rgba(244,67,54,0.1);border-color:rgba(244,67,54,0.2);color:var(--danger)}
  .history-calendar .day-cell.empty{opacity:0.3}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:9999;padding:12px;backdrop-filter:blur(4px)}
  .modal.show{display:flex;animation:fadeIn .3s}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  .modal-card{width:100%;max-width:520px;background:linear-gradient(180deg,#0e1112,#121315);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.04);max-height:90vh;overflow-y:auto;animation:slideUp .3s}
  @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
  .modal-title{font-weight:800;color:var(--accent);margin-bottom:8px;font-size:1.1rem}
  .modal-close{margin-top:10px;padding:8px 12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--danger),#d32f2f);cursor:pointer;color:#fff;font-weight:700;transition:transform .2s}
  .modal-close:hover{transform:scale(1.05)}

  .reminder-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .time-pill{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02)}
  .time-pill input{width:56px;background:transparent;border:none;color:#fff;font-weight:800;font-size:1rem;text-align:center}
  .ampm-toggle{display:flex;gap:8px}
  .ampm-btn{padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);cursor:pointer;background:transparent;color:var(--muted);transition:all .2s}
  .ampm-btn.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#000;font-weight:800}

  .bottom-nav{position:fixed;left:0;right:0;bottom:12px;display:flex;justify-content:center;gap:10px;pointer-events:none;z-index:1000}
  .nav-inner{pointer-events:auto;background:linear-gradient(180deg,#0d1113,#121416);padding:10px;border-radius:999px;border:1px solid rgba(255,255,255,0.04);display:flex;gap:8px;box-shadow:0 8px 32px rgba(0,0,0,0.4)}
  .nav-btn{background:transparent;border:none;padding:8px 12px;border-radius:999px;color:var(--muted);cursor:pointer;font-weight:700;transition:all .2s}
  .nav-btn:hover{color:#fff}
  .nav-btn.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#000}

  @media(max-width:520px){
    .task-content{padding:10px}
    .task-title{font-size:0.95rem}
    .task-meta{flex-direction:column;align-items:flex-end;gap:6px}
    .btn-status{padding:8px 10px;font-size:0.92rem}
    .swipe-delete{width:70px}
    .stat-box{padding:10px}
    .stat-value{font-size:1.5rem}
    .stat-label{font-size:0.72rem}
    .history-calendar .day-cell{min-height:35px;font-size:0.7rem}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìÖ Daily Task Tracker</h1>
      <div id="currentDate" class="current-date"></div>
      <div class="stats-summary">
        <span>üìä 3/5 Done</span>
        <span>üî• 7 Day Streak</span>
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;justify-content:center">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="work">üíº Work</button>
      <button class="filter-btn" data-filter="personal">üè† Personal</button>
      <button class="filter-btn" data-filter="health">üí™ Health</button>
      <button class="filter-btn" data-filter="learning">üìö Learning</button>
    </div>

      <div id="tasksCard" class="card">
        <div class="table-header">
          <div class="left">Task Name</div>
          <div class="right" id="todayHeader">Today</div>
        </div>

        <div id="tasksList" class="tasks-list"></div>
        <div id="emptyState" style="display:none;padding:12px;text-align:center;color:var(--muted)">No tasks yet ‚Äî add your first task.</div>
      </div>
    </div>

    <div id="historySection" class="history-section">
      <div style="font-weight:800;color:var(--accent);margin-bottom:12px;font-size:1.1rem">üìä Task History & Statistics</div>
      
      <div class="card" id="statsCard" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px">
        <div class="stat-box">
          <div class="stat-value" id="statTotalTasks">0</div>
          <div class="stat-label">Total Tasks</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="statCompleted">0</div>
          <div class="stat-label">Completed</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="statDaysTracked">0</div>
          <div class="stat-label">Days Tracked</div>
        </div>
      </div>

      <div class="card">
        <div id="taskHistoryList"></div>
        <div id="noHistory" style="display:none;padding:12px;text-align:center;color:var(--muted)">No task history yet. Complete tasks to populate history.</div>
      </div>
    </div>
  </div>

  <div id="reminderModal" class="modal">
    <div class="modal-card">
      <div class="modal-title">‚è∞ Set Reminder</div>
      <div id="reminderFor" style="color:var(--muted);margin-bottom:8px"></div>

      <div style="display:flex;flex-direction:column;gap:8px">
        <div class="reminder-row">
          <div class="time-pill">
            <input id="remHour" type="number" min="1" max="12" value="12" />
            <span style="font-weight:800">:</span>
            <input id="remMin" type="number" min="0" max="59" value="00" />
          </div>
          <div class="ampm-toggle">
            <button id="ampmAM" class="ampm-btn active">AM</button>
            <button id="ampmPM" class="ampm-btn">PM</button>
          </div>
        </div>
        <textarea id="remNote" placeholder="Optional note" style="min-height:80px;background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px;color:#fff;resize:vertical"></textarea>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="remCancel" style="padding:8px 12px;border-radius:10px;border:none;background:linear-gradient(90deg,#9c27b0,#7b1fa2);cursor:pointer;color:#fff;font-weight:700">Cancel</button>
          <button id="remSave" style="padding:8px 12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#000;cursor:pointer;font-weight:700">Save</button>
        </div>
      </div>
    </div>
  </div>

  <div id="taskHistoryModal" class="modal">
    <div class="modal-card">
      <div id="taskHistoryTitle" class="modal-title">Task History</div>
      <div id="taskHistoryContent"></div>
      <button id="closeTaskHistory" class="modal-close">Close</button>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-inner">
      <button id="navTasks" class="nav-btn active">üìã Tasks</button>
      <button id="navHistory" class="nav-btn">üìä History</button>
    </div>
  </div>

<script>
const TASKS_KEY = 'daily_tasks_v6';
const TASK_HISTORY_KEY = 'daily_task_history_v6';
const LAST_RESET_KEY = 'last_reset_date_v6';

let currentFilter = 'all';
let tasks = [], taskHistory = [], lastResetDate = null, currentReminderTaskId = null;
const DAYS = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
const DAY_NAMES = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

function qs(id){ return document.getElementById(id); }
function nowDateStr(d=new Date()){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function escapeHtml(s){ const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

function loadAll(){
  try{
    tasks = JSON.parse(localStorage.getItem(TASKS_KEY) || '[]');
    taskHistory = JSON.parse(localStorage.getItem(TASK_HISTORY_KEY) || '[]');
    lastResetDate = localStorage.getItem(LAST_RESET_KEY) || null;
  }catch(e){
    console.error('load error', e);
    tasks = []; taskHistory = []; lastResetDate = null;
  }
}

function saveAll(){
  localStorage.setItem(TASKS_KEY, JSON.stringify(tasks));
  localStorage.setItem(TASK_HISTORY_KEY, JSON.stringify(taskHistory));
  localStorage.setItem(LAST_RESET_KEY, lastResetDate || '');
}

function init(){
  loadAll();
  updateCurrentDate();
  checkDailyReset();
  renderTasks();
  renderHistoryView();
  updateStats();
  startTickers();
  attachUI();
}

function updateCurrentDate(){
  const now = new Date();
  qs('currentDate').textContent = now.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  qs('todayHeader').textContent = DAY_NAMES[now.getDay()];
}

function checkDailyReset(){
  const todayStr = nowDateStr();
  if(lastResetDate !== todayStr){
    tasks.forEach(t => {
      t.status = { sunday:null, monday:null, tuesday:null, wednesday:null, thursday:null, friday:null, saturday:null };
      t.reminderShown = false;
    });
    lastResetDate = todayStr;
    saveAll();
    renderTasks();
    updateStats();
  }
}

function filterTasks(category){
  currentFilter = category;
  document.querySelectorAll('.filter-btn').forEach(btn => {
    if(btn.dataset.filter === category){
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });
  renderTasks();
}

function addTaskFromInput(){
  const input = qs('taskInput');
  const categorySelect = qs('categorySelect');
  const title = input.value.trim();
  if(!title) return;
  
  const newTask = { 
    id: Date.now(), 
    title,
    category: categorySelect.value || 'none', // ADD THIS LINE
    status:{ sunday:null,monday:null,tuesday:null,wednesday:null,thursday:null,friday:null,saturday:null }, 
    reminder:null, 
    reminderShown:false 
  };
  
  tasks.push(newTask);
  input.value = '';
  categorySelect.value = ''; // ADD THIS LINE
  saveAll();
  renderTasks();
  renderHistoryView();
  updateStats();
}

function deleteTask(id){
  tasks = tasks.filter(t => t.id !== id);
  taskHistory = taskHistory.filter(h => h.taskId !== id);
  saveAll();
  renderTasks();
  renderHistoryView();
  updateStats();
}

function setTaskStatus(id, val){
  const todayKey = DAYS[new Date().getDay()];
  const t = tasks.find(x => x.id === id);
  if(!t) return;

  t.status[todayKey] = !!val;

  const todayStr = nowDateStr();
  let histTask = taskHistory.find(h => h.taskId === id);
  if(!histTask){
    histTask = { taskId: id, title: t.title, history: [] };
    taskHistory.push(histTask);
  }
  
  const existingIdx = histTask.history.findIndex(h => h.date === todayStr);
  if(existingIdx >= 0){
    histTask.history[existingIdx].status = !!val;
  } else {
    histTask.history.push({ date: todayStr, status: !!val });
  }

  saveAll();
  renderTasks();
  renderHistoryView();
  updateStats();
}

function openReminderModalFor(id){
  const task = tasks.find(t=>t.id===id);
  if(!task) return;
  currentReminderTaskId = id;
  qs('reminderFor').textContent = task.title;
  qs('remHour').value = task.reminder ? task.reminder.hour : 12;
  qs('remMin').value = task.reminder ? String(task.reminder.minute).padStart(2,'0') : '00';
  if(task.reminder && task.reminder.ampm === 'PM'){ 
    qs('ampmPM').classList.add('active'); 
    qs('ampmAM').classList.remove('active'); 
  } else { 
    qs('ampmAM').classList.add('active'); 
    qs('ampmPM').classList.remove('active'); 
  }
  qs('remNote').value = task.reminder ? (task.reminder.note||'') : '';
  showModal('reminderModal');
}

function saveReminderForCurrent(){
  if(!currentReminderTaskId) return;
  const task = tasks.find(t=>t.id===currentReminderTaskId);
  if(!task) return;
  let hour = parseInt(qs('remHour').value,10); 
  if(isNaN(hour)||hour<1) hour=12; 
  if(hour>12) hour=12;
  let minute = parseInt(qs('remMin').value,10); 
  if(isNaN(minute)||minute<0) minute=0; 
  if(minute>59) minute=59;
  const ampm = qs('ampmPM').classList.contains('active') ? 'PM' : 'AM';
  const note = qs('remNote').value.trim();
  task.reminder = { hour, minute, ampm, note };
  task.reminderShown = false;
  saveAll();
  hideModal('reminderModal');
  renderTasks();
  alert('Reminder saved: ' + `${hour}:${String(minute).padStart(2,'0')} ${ampm}`);
}

function renderTasks(){
  const list = qs('tasksList'); 
  list.innerHTML = '';
  const todayKey = DAYS[new Date().getDay()];
  
  if(!tasks || tasks.length===0){ 
    qs('emptyState').style.display='block'; 
    return; 
  } else {
    qs('emptyState').style.display='none';
  }
  
  const sorted = [...tasks].sort((a,b)=>{
    const aDone = a.status && a.status[todayKey] === true;
    const bDone = b.status && b.status[todayKey] === true;
    if(aDone === bDone) return a.title.localeCompare(b.title);
    return aDone ? 1 : -1;
  });
  
  sorted.forEach(task=>{
    const row = document.createElement('div'); 
    row.className='task-row';
    
    const deleteArea = document.createElement('div'); 
    deleteArea.className='swipe-delete'; 
    deleteArea.innerHTML='üóëÔ∏è';
    deleteArea.addEventListener('click', () => {
      if(confirm(`Delete "${task.title}"?`)) {
        deleteTask(task.id);
      }
    });
    
    const content = document.createElement('div'); 
    content.className='task-content';
    
    const title = document.createElement('div'); 
    title.className='task-title'; 
    const categoryIcons = {
      'work': 'üíº',
      'personal': 'üè†',
      'health': 'üí™',
      'learning': 'üìö',
      'none': ''
    };

    const categoryBadge = task.category && task.category !== 'none' 
      ? `<span style="background:rgba(100,255,218,0.1);padding:2px 8px;border-radius:6px;font-size:0.8rem;margin-right:8px">${categoryIcons[task.category] || ''}</span>` 
      : '';

    title.innerHTML = categoryBadge + escapeHtml(task.title);
    
    const meta = document.createElement('div'); 
    meta.className='task-meta';
    
    const bell = document.createElement('div'); 
    bell.className='icon-bell'; 
    bell.innerHTML = 'üîî';
    if(task.reminder){ 
      const b = document.createElement('span'); 
      b.className='badge'; 
      bell.appendChild(b); 
    }
    bell.addEventListener('click', (e)=>{ 
      e.stopPropagation(); 
      openReminderModalFor(task.id); 
    });

    const statusBox = document.createElement('div');
    statusBox.className = 'status-actions';
    const currentStatus = (task.status && typeof task.status === 'object') ? task.status[todayKey] : null;
    
    if(currentStatus === null){
      const yes = document.createElement('button'); 
      yes.className='btn-status btn-yes'; 
      yes.textContent='Yes';
      const no = document.createElement('button'); 
      no.className='btn-status btn-no'; 
      no.textContent='No';
      yes.addEventListener('click', (ev)=>{ 
        ev.stopPropagation(); 
        setTaskStatus(task.id, true); 
      });
      no.addEventListener('click', (ev)=>{ 
        ev.stopPropagation(); 
        setTaskStatus(task.id, false); 
      });
      statusBox.appendChild(yes); 
      statusBox.appendChild(no);
    } else {
      const b = document.createElement('div'); 
      b.className='status-badge ' + (currentStatus ? 'done' : 'failed'); 
      b.textContent = currentStatus ? '‚úì' : '‚úó';
      statusBox.appendChild(b);
    }

    meta.appendChild(bell); 
    meta.appendChild(statusBox);
    content.appendChild(title); 
    content.appendChild(meta);
    row.appendChild(deleteArea); 
    row.appendChild(content);
    bindSwipeToDelete(content, row, task.id);
    list.appendChild(row);
  });
}

function bindSwipeToDelete(contentEl, containerRow, taskId){
  let startX=0, currentX=0, dragging=false;
  const threshold = 90, maxSlide = 110;
  
  function pointerStart(x){ 
    startX = x; 
    currentX = x; 
    dragging = true; 
    contentEl.style.transition='none'; 
  }
  
  function pointerMove(x){ 
    if(!dragging) return; 
    currentX = x; 
    const diff = startX - currentX; 
    if(diff > 0){ 
      const px = Math.min(diff, maxSlide); 
      contentEl.style.transform = `translateX(-${px}px)`; 
      if(px > 20) containerRow.classList.add('show-delete'); 
      else containerRow.classList.remove('show-delete'); 
    } 
  }
  
  function pointerEnd(){ 
    if(!dragging) return; 
    dragging=false; 
    contentEl.style.transition='transform .2s ease'; 
    const diff = startX - currentX; 
    if(diff > threshold){ 
      contentEl.style.transform = `translateX(-${maxSlide}px)`; 
      setTimeout(()=> { 
        if(confirm(`Delete this task?`)) {
          deleteTask(taskId); 
        } else {
          containerRow.classList.remove('show-delete'); 
          contentEl.style.transform = 'translateX(0)';
        }
      },220); 
    } else { 
      containerRow.classList.remove('show-delete'); 
      contentEl.style.transform = 'translateX(0)'; 
    } 
  }
  
  contentEl.addEventListener('touchstart',(e)=>pointerStart(e.touches[0].clientX),{passive:true});
  contentEl.addEventListener('touchmove',(e)=>pointerMove(e.touches[0].clientX),{passive:true});
  contentEl.addEventListener('touchend',()=>pointerEnd());
  contentEl.addEventListener('mousedown',(e)=>pointerStart(e.clientX));
  window.addEventListener('mousemove',(e)=>pointerMove(e.clientX));
  window.addEventListener('mouseup',()=>pointerEnd());
}

function deleteTaskHistory(taskId){
  taskHistory = taskHistory.filter(h => h.taskId !== taskId);
  saveAll();
  renderHistoryView();
  updateStats();
}

function renderHistoryView(){
  const list = qs('taskHistoryList');
  list.innerHTML = '';
  
  if(!taskHistory || taskHistory.length === 0){
    qs('noHistory').style.display = 'block';
    return;
  }
  
  qs('noHistory').style.display = 'none';
  
  taskHistory.forEach(histTask => {
    const task = tasks.find(t => t.id === histTask.taskId);
    if(!task) return;
    
    const row = document.createElement('div');
    row.className = 'history-item-row';
    
    const deleteArea = document.createElement('div');
    deleteArea.className = 'history-delete';
    deleteArea.innerHTML = 'üóëÔ∏è';
    deleteArea.addEventListener('click', () => {
      if(confirm(`Delete history for "${histTask.title}"?`)) {
        deleteTaskHistory(histTask.taskId);
      }
    });
    
    const item = document.createElement('div');
    item.className = 'task-history-item';
    
    const title = document.createElement('div');
    title.className = 'task-history-title';
    title.textContent = histTask.title;
    
    const stats = document.createElement('div');
    stats.className = 'task-history-stats';
    
    const totalDays = histTask.history.length;
    const completedDays = histTask.history.filter(h => h.status).length;
    const failedDays = histTask.history.filter(h => !h.status).length;
    
    stats.innerHTML = `
      <div class="task-history-stat"><span style="color:var(--success)">‚úì</span> ${completedDays}</div>
      <div class="task-history-stat"><span style="color:var(--danger)">‚úó</span> ${failedDays}</div>
      <div class="task-history-stat"><span style="color:var(--muted)">üìÖ</span> ${totalDays} days</div>
    `;
    
    item.appendChild(title);
    item.appendChild(stats);
    
    item.addEventListener('click', () => openTaskHistoryModal(histTask.taskId));
    
    row.appendChild(deleteArea);
    row.appendChild(item);
    bindSwipeToDeleteHistory(item, row, histTask.taskId);
    list.appendChild(row);
  });
}

function bindSwipeToDeleteHistory(contentEl, containerRow, taskId){
  let startX=0, currentX=0, dragging=false;
  const threshold = 90, maxSlide = 110;
  
  function pointerStart(x){ 
    startX = x; 
    currentX = x; 
    dragging = true; 
    contentEl.style.transition='none'; 
  }
  
  function pointerMove(x){ 
    if(!dragging) return; 
    currentX = x; 
    const diff = currentX - startX; // Reversed for left swipe
    if(diff > 0){ 
      const px = Math.min(diff, maxSlide); 
      contentEl.style.transform = `translateX(${px}px)`; 
      if(px > 20) containerRow.classList.add('show-delete'); 
      else containerRow.classList.remove('show-delete'); 
    } 
  }
  
  function pointerEnd(){ 
    if(!dragging) return; 
    dragging=false; 
    contentEl.style.transition='transform .2s ease'; 
    const diff = currentX - startX; // Reversed for left swipe
    if(diff > threshold){ 
      contentEl.style.transform = `translateX(${maxSlide}px)`; 
      setTimeout(()=> { 
        if(confirm(`Delete history for this task?`)) {
          deleteTaskHistory(taskId); 
        } else {
          containerRow.classList.remove('show-delete'); 
          contentEl.style.transform = 'translateX(0)';
        }
      },220); 
    } else { 
      containerRow.classList.remove('show-delete'); 
      contentEl.style.transform = 'translateX(0)'; 
    } 
  }
  
  contentEl.addEventListener('touchstart',(e)=>pointerStart(e.touches[0].clientX),{passive:true});
  contentEl.addEventListener('touchmove',(e)=>pointerMove(e.touches[0].clientX),{passive:true});
  contentEl.addEventListener('touchend',()=>pointerEnd());
  contentEl.addEventListener('mousedown',(e)=>pointerStart(e.clientX));
  window.addEventListener('mousemove',(e)=>pointerMove(e.clientX));
  window.addEventListener('mouseup',()=>pointerEnd());
}

function openTaskHistoryModal(taskId){
  const histTask = taskHistory.find(h => h.taskId === taskId);
  const task = tasks.find(t => t.id === taskId);
  
  if(!histTask || !histTask.history || histTask.history.length === 0){
    alert('No history recorded for this task yet.');
    return;
  }

  qs('taskHistoryTitle').textContent = `üìà ${task ? task.title : histTask.title}`;
  
  const content = qs('taskHistoryContent');
  content.innerHTML = '';

  const statsDiv = document.createElement('div');
  statsDiv.style.cssText = 'display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px';
  
  const completed = histTask.history.filter(h => h.status).length;
  const total = histTask.history.length;
  const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
  
  const completedBox = document.createElement('div');
  completedBox.className = 'stat-box';
  completedBox.innerHTML = `<div class="stat-value">${completed}/${total}</div><div class="stat-label">Completed</div>`;
  
  const percentBox = document.createElement('div');
  percentBox.className = 'stat-box';
  percentBox.innerHTML = `<div class="stat-value">${percentage}%</div><div class="stat-label">Success Rate</div>`;
  
  statsDiv.appendChild(completedBox);
  statsDiv.appendChild(percentBox);
  content.appendChild(statsDiv);

  // Create calendar
  const calendarDiv = document.createElement('div');
  calendarDiv.className = 'history-calendar';
  
  const weekdaysDiv = document.createElement('div');
  weekdaysDiv.className = 'weekdays';
  ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
    const wd = document.createElement('div');
    wd.className = 'weekday';
    wd.textContent = day;
    weekdaysDiv.appendChild(wd);
  });
  calendarDiv.appendChild(weekdaysDiv);

  // Sort history by date
  const sortedHistory = [...histTask.history].sort((a, b) => new Date(a.date) - new Date(b.date));
  
  if(sortedHistory.length > 0) {
    const firstDate = new Date(sortedHistory[0].date);
    const lastDate = new Date(sortedHistory[sortedHistory.length - 1].date);
    
    // Create a map for quick lookup
    const historyMap = {};
    sortedHistory.forEach(h => {
      historyMap[h.date] = h.status;
    });

    const daysGrid = document.createElement('div');
    daysGrid.className = 'days-grid';

    // Start from first Sunday before or on first date
    const startDate = new Date(firstDate);
    startDate.setDate(startDate.getDate() - startDate.getDay());

    // End on last Saturday after or on last date
    const endDate = new Date(lastDate);
    endDate.setDate(endDate.getDate() + (6 - endDate.getDay()));

    let currentDate = new Date(startDate);
    while(currentDate <= endDate) {
      const dateStr = nowDateStr(currentDate);
      const dayCell = document.createElement('div');
      dayCell.className = 'day-cell';
      
      const dayNum = document.createElement('div');
      dayNum.className = 'day-num';
      dayNum.textContent = currentDate.getDate();
      
      const dayStatus = document.createElement('div');
      dayStatus.className = 'day-status';
      
      if(historyMap.hasOwnProperty(dateStr)) {
        if(historyMap[dateStr]) {
          dayCell.classList.add('completed');
          dayStatus.textContent = '‚úÖ';
        } else {
          dayCell.classList.add('failed');
          dayStatus.textContent = '‚ùå';
        }
      } else {
        if(currentDate < firstDate || currentDate > lastDate) {
          dayCell.classList.add('empty');
          dayStatus.textContent = '';
        } else {
          dayStatus.textContent = '‚Äî';
        }
      }
      
      dayCell.appendChild(dayNum);
      dayCell.appendChild(dayStatus);
      daysGrid.appendChild(dayCell);
      
      currentDate.setDate(currentDate.getDate() + 1);
    }
    
    calendarDiv.appendChild(daysGrid);
  }
  
  content.appendChild(calendarDiv);
  showModal('taskHistoryModal');
}

function updateStats(){
  const totalTasks = tasks.length;
  const todayStr = nowDateStr();
  const todayKey = DAYS[new Date().getDay()];
  
  // Count only TODAY's completed tasks
  let todayCompleted = 0;
  tasks.forEach(task => {
    const currentStatus = (task.status && typeof task.status === 'object') ? task.status[todayKey] : null;
    if(currentStatus === true) {
      todayCompleted++;
    }
  });
  
  // Count unique days with task history
  const uniqueDates = new Set();
  taskHistory.forEach(histTask => {
    histTask.history.forEach(h => {
      uniqueDates.add(h.date);
    });
  });
  
  const daysTracked = uniqueDates.size;
  
  qs('statTotalTasks').textContent = totalTasks;
  qs('statCompleted').textContent = todayCompleted;
  qs('statDaysTracked').textContent = daysTracked;
}

function showModal(id){
  qs(id).classList.add('show');
}

function hideModal(id){
  qs(id).classList.remove('show');
}

function attachUI(){
  qs('addBtn').addEventListener('click', addTaskFromInput);
  qs('taskInput').addEventListener('keypress', (e) => {
    if(e.key === 'Enter') addTaskFromInput();
  });

  qs('ampmAM').addEventListener('click', () => {
    qs('ampmAM').classList.add('active');
    qs('ampmPM').classList.remove('active');
  });

  qs('ampmPM').addEventListener('click', () => {
    qs('ampmPM').classList.add('active');
    qs('ampmAM').classList.remove('active');
  });

  qs('remSave').addEventListener('click', saveReminderForCurrent);
  qs('remCancel').addEventListener('click', () => hideModal('reminderModal'));
  qs('closeTaskHistory').addEventListener('click', () => hideModal('taskHistoryModal'));

  // Navigation
  qs('navTasks').addEventListener('click', () => {
    qs('navTasks').classList.add('active');
    qs('navHistory').classList.remove('active');
    qs('tasksView').style.display = 'block';
    qs('historySection').classList.remove('active');
  });

  qs('navHistory').addEventListener('click', () => {
    qs('navHistory').classList.add('active');
    qs('navTasks').classList.remove('active');
    qs('tasksView').style.display = 'none';
    qs('historySection').classList.add('active');
    renderHistoryView();
    updateStats();
  });

  // Close modals on background click
  qs('reminderModal').addEventListener('click', (e) => {
    if(e.target === qs('reminderModal')) hideModal('reminderModal');
  });

  qs('taskHistoryModal').addEventListener('click', (e) => {
    if(e.target === qs('taskHistoryModal')) hideModal('taskHistoryModal');
  });
}

function startTickers(){
  setInterval(() => {
    updateCurrentDate();
    checkDailyReset();
  }, 60000); // Check every minute
  
  // Check reminders every 30 seconds
  setInterval(() => {
    checkReminders();
  }, 30000);
  
  // Initial check
  checkReminders();
}

function checkReminders(){
  const now = new Date();
  const currentHour = now.getHours();
  const currentMinute = now.getMinutes();
  
  tasks.forEach(task => {
    if(!task.reminder || task.reminderShown) return;
    
    let reminderHour = task.reminder.hour;
    if(task.reminder.ampm === 'PM' && reminderHour !== 12) {
      reminderHour += 12;
    } else if(task.reminder.ampm === 'AM' && reminderHour === 12) {
      reminderHour = 0;
    }
    
    const reminderMinute = task.reminder.minute;
    
    // Calculate 1 minute before reminder time
    let alertHour = reminderHour;
    let alertMinute = reminderMinute - 1;
    
    if(alertMinute < 0) {
      alertMinute = 59;
      alertHour -= 1;
      if(alertHour < 0) alertHour = 23;
    }
    
    // Check if current time matches alert time (1 minute before)
    if(currentHour === alertHour && currentMinute === alertMinute) {
      const noteText = task.reminder.note ? `\n\nNote: ${task.reminder.note}` : '';
      const timeStr = `${task.reminder.hour}:${String(task.reminder.minute).padStart(2,'0')} ${task.reminder.ampm}`;
      alert(`‚è∞ Reminder: ${task.title}\n\nScheduled for: ${timeStr}${noteText}`);
      task.reminderShown = true;
      saveAll();
    }
  });
}

// Initialize app
init();
</script>
</body>
</html>